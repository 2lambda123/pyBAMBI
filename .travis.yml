# linux matrix
language: python
os: linux
python:
    - "3.6"
    #    - "3.5"
    #    - "3.4"
    - "2.7"
env:
  - MPI=
  - MPI=1

# OSX matrix
matrix:
    include:
        - os: osx
          language: generic
          env: PYTHON_VERSION=python2 MPI=
        - os: osx
          language: generic
          env: PYTHON_VERSION=python2 MPI=1
        - os: osx
          language: generic
          env: PYTHON_VERSION=python3 MPI=
        - os: osx
          language: generic
          env: PYTHON_VERSION=python3 MPI=1


# OSX setup
before_install:
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pip install virtualenv ; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then virtualenv venv -p $PYTHON_VERSION; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then source venv/bin/activate; fi

install:
    - mkdir external
    - cd external

    # System installation requirements
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; 
      then 
          brew install gcc;
          find /usr/local/Cellar/gcc;
      else sudo apt-get install gfortran libblas3 liblapack3; 
      fi
    - if [ "$MPI" ]; then
          if [[ "$TRAVIS_OS_NAME" == "osx" ]]; 
          then brew install open-mpi;
          else sudo apt-get install openmpi-bin libopenmpi-dev;
          fi;
          pip install mpi4py;
      fi
    - /usr/bin/gcc --version
    - /usr/bin/g++ --version
    - gfortran --version; which gfortran

    # PolyChord install
    - git clone https://github.com/PolyChord/PolyChordLite PolyChord
    - cd PolyChord
    - make MPI=$MPI pypolychord
    - python setup.py install
    - cd ..

    # MultiNest install
    - git clone https://github.com/JohannesBuchner/MultiNest MultiNest
    - cd MultiNest/build
    - cmake ..
    - make
    - cd ../../
    - export LD_LIBRARY_PATH=$PWD/MultiNest/lib/:${LD_LIBRARY_PATH} 

    # PyMultiNest install
    - git clone https://github.com/williamjameshandley/PyMultiNest PyMultiNest
    - cd PyMultiNest
    - python setup.py install
    - cd ..

    # requirements install
    - cd ..
    - pip install -r requirements.txt
    - pip install pytest pytest-cov codecov

script:
    - if [ "$MPI" ];
      then
          mpirun -np 2 python -m pytest tests;
      else
          python -m pytest tests --cov=pybambi;
      fi

after_success:
    - codecov
